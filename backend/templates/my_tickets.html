<!DOCTYPE html>
<html>
<head>
    <title>æˆ‘çš„ç¥¨</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <main class="container">
        <header>
            <h1>ğŸ«æˆ‘çš„NFTç¥¨åŠ¡ä¸­å¿ƒ</h1>
        </header>
        <!-- tabåˆ‡æ¢ -->
        <div class="tabs">
            <div class="tab active" onclick="showTab('primary')">ä¸€çº§å¸‚åœº</div>
            <div class="tab" onclick="showTab('secondary')">äºŒçº§å¸‚åœº</div>
        </div>
        <!-- ä¸€çº§å¸‚åœº -->
        <section id="primary" class="marketplace tab-content active">
            <h2>ğŸ›’å¹³å°åœ¨å”®ç¥¨åˆ¸</h2>
            {% for ticket in tickets_for_sale_primary %}
                <div class="ticket">
                    <p><strong>æ´»åŠ¨ï¼š</strong> {{ ticket.event }}</p>
                    <p><strong>æ—¶é—´ï¼š</strong> {{ ticket.date }}</p>
                    <p><strong>ä»·æ ¼ï¼š</strong> {{ ticket.price }} ETH</p>
                    <p><strong>æè¿°ï¼š</strong> {{ ticket.description }}</p>
                    <p><strong>Token ID:</strong> {{ ticket.token_id }}</p>
                    <div>
                        <button onclick="buyTicketWithMetaMask(event, {{ ticket.token_id }})" class="btn">ç«‹å³è´­ä¹°</button>
                        <script>
                            async function buyTicketWithMetaMask(event, tokenId) {

                                event.preventDefault();
                                if (typeof window.ethereum !== 'undefined') {
                                    try {
                                        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                                        const userAddress = accounts[0];
                                        const response = await fetch(`/buy_ticket/${tokenId}`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ buyer_address: userAddress })
                                        });
                                        const result = await response.json();
                                        if (result.success) {
                                            alert('ğŸ‰ è´­ç¥¨æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ' + result.tx_hash);
                                            window.location.reload();  // åˆ·æ–°é¡µé¢åŠ è½½â€œæˆ‘çš„ç¥¨â€
                                            } else {alert('âŒ è´­ç¥¨å¤±è´¥: ' + result.error);}
                                            } catch (err) {
                                            console.error(err);
                                            alert("MetaMaské”™è¯¯: " + err.message);
                                            }
                                            } else {
                                            alert("è¯·å…ˆå®‰è£… MetaMask æ’ä»¶");
                                }
                            }
                        </script>
                    </div>
                </div>
            {% else %}
                <p>å½“å‰æš‚æ— ç¥¨åˆ¸åœ¨å”®~</p>
            {% endfor %}
        </section>

        <!-- äºŒçº§å¸‚åœº -->
        <section id="secondary" class="marketplace tab-content">
            <h2>ğŸ‘¥ç”¨æˆ·è½¬å”®ç¥¨åˆ¸</h2>
            {% for ticket in tickets_for_sale_secondary %}
                <div class="ticket">
                    <p><strong>æ´»åŠ¨ï¼š</strong> {{ ticket.event }}</p>
                    <p><strong>æ—¶é—´ï¼š</strong> {{ ticket.date }}</p>
                    <p><strong>ä»·æ ¼ï¼š</strong> {{ ticket.price }} ETH</p>
                    <p><strong>æè¿°ï¼š</strong> {{ ticket.description }}</p>
                    <p><strong>Token ID:</strong> {{ ticket.token_id }}</p>
                    <form action="/buy_ticket/{{ ticket.token_id }}" method="POST">
                        <button class="btn">ç«‹å³è´­ä¹°</button>
                    </form>
                </div>
            {% else %}
                <p>å½“å‰æš‚æ— ç”¨æˆ·è½¬å”®ç¥¨åˆ¸ã€‚</p>
            {% endfor %}
        </section>

        <section class="my-tickets">
            <h2>ğŸ«æˆ‘çš„ç¥¨åˆ¸</h2>
            {% for ticket in tickets %}
                <div class="ticket">
                    <p><strong>æ´»åŠ¨ï¼š</strong> {{ ticket["event"] }}</p>
                    <p><strong>æ—¶é—´ï¼š</strong> {{ ticket["date"] }}</p>
                    <p><strong>ä»·æ ¼ï¼š</strong> {{ ticket["price"] }} ETH</p>
                    <p><strong>æè¿°ï¼š</strong> {{ ticket["description"] }}</p>
                    <p><strong>Token ID:</strong> {{ ticket["token_id"] }}</p>

                <!-- è½¬å”®æŒ‰é’® -->
                    <form action="/resell_ticket/{{ ticket.token_id }}" method="POST">
                        <button class="btn">è½¬å”®</button>
                    </form>
                </div>
            {% else %}
                <p>è¯¶âˆ‘( å£ ||ä½ è¿˜æ²¡æœ‰ç¥¨å“¦ï¼Œå¿«å»ä¹°ä¸€å¼ è¯•è¯•å§ï¼</p>
            {% endfor %}
        </section>

        <footer>
            <a href="/" class="btn">è¿”å›é¦–é¡µ</a>
        </footer>
    </main>

    <script>
        function showTab(tabId) {
            // åˆ‡æ¢æŒ‰é’®æ ·å¼
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');

            // åˆ‡æ¢å†…å®¹åŒº
            document.querySelectorAll('.tab-content').forEach(section => section.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }
    </script>
</body>
</html>
